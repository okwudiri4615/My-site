<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Notices | </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">

<style>
.material-symbols-rounded{
  font-variation-settings:'FILL' 1,'wght' 500,'opsz' 24;
}
.glass{
  background:rgba(255,255,255,.82);
  backdrop-filter:blur(18px);
  box-shadow:0 25px 60px rgba(0,0,0,.12);
}
.badge{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  font-weight:600;
}
@keyframes pulse{
  0%{opacity:.6}
  50%{opacity:1}
  100%{opacity:.6}
}
.skeleton{
  animation:pulse 1.5s ease-in-out infinite;
}
</style>
</head>

<body class="bg-gradient-to-br from-[#f4f6fb] to-[#edf0f8] text-slate-800">

<main class="max-w-3xl mx-auto p-6 space-y-6">

<!-- HEADER -->
<div class="flex items-center justify-between">
  <a href="student-dashboard.html" class="flex items-center gap-2 text-indigo-600 font-semibold">
    <span class="material-symbols-rounded">arrow_back</span> Dashboard
  </a>
  <h1 class="text-2xl font-black">Department Notices</h1>
</div>

<!-- NOTICE LIST -->
<div id="noticeList" class="space-y-6">

  <!-- SKELETON -->
  <div class="glass rounded-3xl p-6 space-y-4 skeleton">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 bg-slate-200 rounded-full"></div>
      <div class="flex-1 space-y-2">
        <div class="h-4 bg-slate-200 rounded w-1/3"></div>
        <div class="h-3 bg-slate-200 rounded w-1/4"></div>
      </div>
      <div class="h-5 w-16 bg-slate-200 rounded-full"></div>
    </div>
    <div class="space-y-2">
      <div class="h-4 bg-slate-200 rounded"></div>
      <div class="h-4 bg-slate-200 rounded w-5/6"></div>
      <div class="h-4 bg-slate-200 rounded w-2/3"></div>
    </div>
  </div>

  <div class="glass rounded-3xl p-6 space-y-4 skeleton">
    <div class="flex items-center gap-3">
      <div class="h-10 w-10 bg-slate-200 rounded-full"></div>
      <div class="flex-1 space-y-2">
        <div class="h-4 bg-slate-200 rounded w-1/3"></div>
        <div class="h-3 bg-slate-200 rounded w-1/4"></div>
      </div>
      <div class="h-5 w-16 bg-slate-200 rounded-full"></div>
    </div>
    <div class="space-y-2">
      <div class="h-4 bg-slate-200 rounded"></div>
      <div class="h-4 bg-slate-200 rounded w-5/6"></div>
      <div class="h-4 bg-slate-200 rounded w-2/3"></div>
    </div>
  </div>

</div>

</main>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const sb = supabase.createClient(
  "https://pymotnfhhiwugjwsbmsc.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5bW90bmZoaGl3dWdqd3NibXNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTcyMDgsImV4cCI6MjA4NDA3MzIwOH0.-zuyCvMj0A-Vzm30q0hLgev-0z8bjgvgPokBwtnFrH0"
);

/* ---------- HELPERS ---------- */

function formatNoticeText(text=""){
  text = text.trim();

  if(text.match(/^- /m)){
    const items = text.split(/\n/).filter(l=>l.startsWith("- "));
    return `<ul class="list-disc pl-5 space-y-1">
      ${items.map(i=>`<li>${i.replace("- ","")}</li>`).join("")}
    </ul>`;
  }

  return text
    .split(/\n\s*\n/)
    .map(p =>
      `<p>${p
        .replace(/\*([^*]+)\*/g,"<b>$1</b>")
        .replace(/\n/g,"<br>")
      }</p>`
    )
    .join("");
}

function detectCategory(text=""){
  const t = text.toLowerCase();
  if(t.includes("urgent") || t.includes("attention")) return ["URGENT","bg-red-100 text-red-600"];
  if(t.includes("exam")) return ["EXAM","bg-orange-100 text-orange-600"];
  return ["INFO","bg-slate-100 text-slate-600"];
}

function timeAgo(date){
  const diff = (Date.now() - new Date(date)) / 1000;
  if(diff < 60) return "Just now";
  if(diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if(diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  return new Date(date).toDateString();
}

/* ---------- LOAD NOTICES ---------- */

async function loadNotices(){
  const { data:notices=[] } = await sb
    .from("notices")
    .select("*")
    .order("pinned",{ascending:false})
    .order("created_at",{ascending:false});

  noticeList.innerHTML = notices.map(n=>{
    const [label, color] = detectCategory(n.content);

    return `
    <div class="glass rounded-3xl p-6 space-y-4 fade-in">

      ${n.pinned ? `
      <div class="flex items-center gap-2 text-indigo-600 text-sm font-semibold">
        <span class="material-symbols-rounded">push_pin</span> Pinned Notice
      </div>` : ""}

      <div class="flex items-center gap-3">
        <img src="${n.moderator_avatar ||
          'https://ui-avatars.com/api/?name=Course+Rep&background=6366f1&color=fff'}"
          class="h-10 w-10 rounded-full">

        <div>
          <div class="flex items-center gap-1 font-bold">
            General Course Rep
            <span class="material-symbols-rounded text-blue-500" style="font-size:18px">
              verified
            </span>
          </div>
          <p class="text-xs text-slate-400">${timeAgo(n.created_at)}</p>
        </div>

        <span class="ml-auto badge ${color}">${label}</span>
      </div>

      <div class="text-sm text-slate-700 space-y-3">
        ${formatNoticeText(n.content)}
      </div>

      ${n.image_url ? `
      <img src="${n.image_url}" class="rounded-xl max-h-80 w-full object-cover">` : ""}

      ${n.link_url ? `
      <a href="${n.link_url}" target="_blank"
        class="text-indigo-600 text-sm font-semibold hover:underline">
        View attachment â†’
      </a>` : ""}

    </div>
    `;
  }).join("") || `
    <p class="text-center text-slate-400">No notices yet</p>
  `;
}

loadNotices();
</script>

</body>
</html>